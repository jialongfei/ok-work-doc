
# 在线问诊合并支付接入的需求梳理

#### 一、业务流程梳理

* 支付页面接收传递参数
* 根据参数请求保单信息接口
* 根据接口返回值填充页面中各栏目内容
* 根据用户的选择调用不同的支付接口
* 支付接口根据该笔保单标识再次获取保单信息，判断各参数是否属实，是否被篡改过，如果不属实则返回非法请求，如果属实则继续向下执行
* 扣用户的款

    失败 -> 返回支付失败信息，支付终止
    
    成功 -> 充值到我们的账簿

* 扣保险公司的款 -> 扣款成功 -> 充值到我们的账簿

    失败 -> 返回支付失败信息，支付终止 （是否需要我们垫付）

    成功 -> 充值到我们的账簿

* 双方扣款完成后，返回结果，告知接入商该笔收款请求已递交银行处理，需等待回调
* 回调中返回收款的最终结果

#### 二、需要确认的

**1.跳转到我们的支付页面时，可以提供哪些信息，用于我们识别用户和该笔支付需要使用哪个保单**

    支付页面至少需要以下参数：
      a.保单标识：当前要使用的这张保单的唯一标识
      b.回调地址：接入商用于接收该笔支付是否完全完成的回调地址
 
    结论：提供`预理赔编号`，该编号可获取到用户和保单的相关信息
    
**2.如何扣保险公司的款，扣保险公司的款是否像银行卡扣款一样需要等待回调才得知是否扣款完成**

    假设用户使用银行卡支付，需要等待支付回调，回调中确认支付成功才能扣保险公司的款，如果保险公司扣款结果也需要回调通知的话，该支付流程的完整响应时间会一定程度降低用户体验

    结论：无需等待回调，目前由我们直接垫付，即用户扣款成功后直接从我们账簿清分指定金额到医院账簿。但在垫付前，会检查该保险公司的余额是否充足（新开一个数据表，用于记录各保险公司在我们这里的 充值/可透支 额度，和使用记录）

**3.如果保险公司扣款失败，如何处理**

    a.我们垫付
    b.用户的钱原路返回
    PS： 以下两种方法用户体验较差，不适合这种时效性较高的应用场景
    c.我们发送通知给管理员，人工操作（短信发送有概率极低的失败率）
    d.我们发送通知给用户，联系客服（短信发送有概率极低的失败率）
    
    结论：保险公司扣款失败后，记录异常，并继续往后执行，人工处理
    
**4.需要一个保单信息的接口（通过保单唯一标识获取保单信息的接口）**

    在用户进入支付页面 和 提交支付请求时，通过保单唯一标识分别请求这个接口进行获取相关信息和验证该保单是否存在，相关参数是否有异常
    
    目前 http://dbm.fuli.org.cn:8010/ 文档这里看起来未找到合适的接口
    
    结论：有该接口，编写中
    
**5.需要确认下我们的回调方式**

    通常我们只需要一个回调，告知接入方该笔支付的结果，该笔交易即完全结束，但由于用户可以在支付失败后继续发起支付（如余额不足后可以换卡支付），因此一个回调直接强制结束的逻辑看起来不太合理。
    
    方案a.仅一次回调，在完全支付成功时发起回调
    优势：接入方接入成本低
    劣势：用户若支付失败，用户和接入方均无法得知该笔支付的失败原因
    
    方案b.多次回调，每次操作的结果均回调给接入方
    优势：用户可查看到自己交易失败的记录和失败原因
    劣势：接入方接入成本可能略高，需要根据我们的多次回调结果，判断该笔支付是否已成功，并更新该状态到自己的系统中
    
    结论：二次回调，5秒钟后无响应，则回调超时需等待后续回调，在后续回调中告知支付结果



#### 三、需要接入商了解的

**1.跳转到我们的支付页面时，需要携带参数**

    a.回调地址，用于在支付完全成功或失败时给接入方发送反馈
    b.保单信息，至少包含唯一标识，用于发起支付时验证各参数的准确性

**2.我们的支付功能有多次异步的回调：**

    用户在进入我们的支付页面后，大多数即时错误提示会直接返回并展示到当前页面，只有在确认该笔交易完全终止或完全完成后，才会发起回调，并告知交易结果

**3.错误码映射表 （后期会贴入接口文档中）**

    该映射表并非最终版本，会随着项目的进度增减
    * 代表该项可能会出现在回调的结果中，接入方可通过该内容决定下一步操作
    未加 * 的错误，通常会在支付页直接提示用户错误原因，不会返回给接入方

#### 四、我的任务：

1.预留功能 

    a.多种用户支付方式
    b.多种保险公司扣款方式
    当前是基于原始的支付功能完成需求，梳理一下，确认是否可扩展
    
    结论：
    a.（若接入其他服务商，目前无法预估，需要根据接口文档决定是否可在原有基础扩展）
    b.（可预留）
    
2.文档编写

    a.先准备初版错误对照表，列出所有目前能预见的错误信息
    b.编码时编写文档，并对错误对照表进行完善

3.新建数据表

    用于记录各保险公司在我司的可用额度 和 扣款记录

    **payment_record_of_insurance_company**
    id 			编号
    ic_id 		保险公司代码 （picc、pingan...）
    type 		类型 （1=存入 2=支出）
    amount 		金额
    target 		涉及订单 (可能是bill订单，也可能是车险保单号，需再次确认)
    created_at 	发生时间
    
4.新增+修改 - 页面

    1.新增保单列表页、保单确认页
    2.修改 购物车、支付结果页 
    3.提供给财务的流水页，展示该类型支付当日的所有记录，及当日需要转账给医院的总额(医院的账簿余额)
    
        a.增 - 保单信息确认页
          需要当前用户的已有保单列表接口
        b.增 - 保单确认页
          需要当前选择保单的详情接口
          确认后生成支付订单并跳转到收银台
        c.改 - 收银台 /pages/cashier/cashier?order_phid=xxx
          页面排版样式
          通过传递的参数，调用保险接口获取信息，并渲染到页面
        d.改 - 支付状态页 /pages/pay-success/pay-success?order_phid=xxx
          页面排版样式
        e.增 - 财务需要的流水页
          展示当天所有该类型支付的记录，且需提供确认和异常按钮，确认后将余额提现，异常则排查原因

5.新增 - 接口A

    1.接受支付请求，再次请求保险接口进行验证(防止用户恶意篡改数据)
    2.执行双方的扣款动作
    2.若有一方扣款失败，则此次请求失败，返回失败状态和失败信息
    3.若双方扣款提交成功，且均已加入我们的账簿，则将接入方传递的回调地址保存至该支付记录的特定字段中（具体字段或存储位置另行确认）
    4.返回该支付已提交银行处理，需等待回调

6.修改 - 接口B

    1.支付回调中判断是否是该类型支付，如果是
    2.根据支付回调的结果，通过方法C返回给接入方本次交易的最终结果

7.新增 - 方法C

    根据回调中的特定参数，获取当前记录接入方发送的回调地址，并请求该地址发送该笔收款的最终结果

8.新增 - 转账接口(也可能是提现接口)

    新增一个手动提现接口，财务查看支付流水页，确认金额无误后点击确认，医院账簿当日的余额将提现到医院提供的账户中

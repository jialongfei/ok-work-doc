# 商保直付通 - 接入文档



> 请注意：该文档暂未完结，请求地址暂不可访问，持续更新中...



> 为保护双方公司利益，防止其他用户恶意攻击，接口均不直接展示错误信息，只返回错误代码，具体错误原因接入方根据错误代码在文档底部的错误代码对照表中查阅



### 业务逻辑

**1.从三方应用进入我们的保单选择页面**

    需携带预理赔编号和回调地址(用于请求获取有效保单列表接口)
    请求有效保单列表接口查看当前用户所有符合条件的有效保单
    用户可选择具体要使用哪个保单
    选择后进入保单详情确认页

**2.保单详情确认页面**

    根据用户选择的保单编号，请求接口获取该保单详细信息以供用户确认（如:需自付多少钱，保险公司付多少钱）
    确认后生成我们的支付订单 （在订单中将此订单标记【PHID-CYZF-xxxx】为特殊订单，并在支付成功的回调中通过该标识判断是否需要进行下一步的特殊处理。订单必须要在进入支付页面之前创建，否则无法进入支付页面）
    返回生成的订单编号，跳转并将该订单编号传递到支付页面

**3.进入支付页面**

    根据订单编号获取订单信息
    用户选择支付方式
    a.余额支付：
        直接返回结果，成功直接将支付结果回调到接入方
        失败则提示用户，并可继续选择其他方式付款，不发起回调
    b.绑卡支付：
        本地可控的支付失败信息，直接提示给用户，用户可继续付款，不发起回调
        需要等待银行方回调的支付结果，均会在得到银行方的回调结果后，通过回调发送给接入方
        银行回调若超过5秒钟，则先回调支付超时给到接入方，接入方可继续等待下次回调 (可能成功，可能失败)
    c.支付宝支付：
        暂无
    d.微信支付：
        暂无

**4.钱包该类型支付逻辑**

    用户支付成功后，
    通过该保单信息获取相关保险公司代码，通过保险公司代码判断该保险公司在我司可用 余额/额度 是否足够本次支付
    足够，则通过我们的账簿清分给指定账簿对应的款项
    不够，则发送异常信息，并继续通过我们的账簿清分给指定账簿对应的款项
    若我司账簿余额不足以支付当前交易的金额，则发送异常信息给我司管理员，并继续向下执行，回调给接入方，该笔支付已完成，程序未完成的部分动作由我司管理员当日指定时间之前手动操作（清分账簿充值，清分指定金额到指定账簿）
    清分完成后，回调接入方，该笔支付已完成

**其他：**

    若用户支付失败，或支付中途跳出我们的钱包，再次进入或返回时，只要页面有刷新，则无法继续操作该订单(我们平台的订单)，而是重新发起一个新的订单
        BUG：如果用户在支付提交成功，等到钜石回调时，再次从接入方再次发起支付，则无论前一笔支付成功与否，均会产生两笔支付
    
    如果希望用户在下次进入钱包时依然能操作该订单
    1.支付失败的记录也显示在钱包记录，且需要在支付失败的记录详情页新增可以再次发起支付的功能
    2.用户在从第三方应用过来的时候直接携带我们钱包的支付订单号
        如果是该方式处理，当用户确认保单后，在我们平台发起订单时就需要给接入方一个回调，将该订单号反馈给接入方供其记录，当用户再次支付该订单时，接入方需要将该订单号传送过来
        我们在保单选择页判断参数，如果携带订单号，则直接跳转到支付页面，如果未携带订单号，则跳转到保单选择页面
        （至于为什么在一开始生成订单号的时候就回调给接入方，是因为这样BUG隐患较少，可防止如：用户生成订单号到支付页面后直接退出，再次从接入方的平台进入我们的保单选择页面，再次生成订单的情况）

**已知：**

* 保单详情接口中可以提供保险公司代码
* 保险公司列表在 api_core_v2 数据库中
* 通过ic_code=xxx和type=1获取当前保险公司充值记录并叠加获取总额度
* 通过ic_code=xxx和type=2获取当前保险公司扣款记录并叠加获取总使用额度
* 通过总额度 - 总使用额度 获取 剩余额度是否够支付当前这笔订单
* 在合适的时间（支付前）保存该笔订单的接入方回调信息，并记录该订单的特殊标识
* 在支付完成后（即时成功或钜石回调完成） 通过该标识判断是否需要后续操作，如果需要，往下进行，否则不做其他处理
* 获取到该订单的回调信息，并根据支付的最终结果，发送回调给接入方



# 接口列表



### 1.引导用户到直付页



接入方只需将携带一些参数，并将用户引导到直付的页面即可，用户的支付结果会通过接入方传递的回调地址，发送给接入方



请求方式：get

请求地址：https://ok-api.okchexian.com/wallet/index.html#/pages/valid-policy/valid-policy



##### 请求参数列表

<table align="center">
    <tr align="center">
        <td>参数名称</td>
        <td>类型</td>
        <td>必选</td>
        <td>可为空</td>
        <td>参数描述</td>
    </tr>
    <tr align="center">
        <td>amout</td>
        <td>int/float(最多支持两位小数点)</td>
        <td>Y</td>
        <td>N</td>
        <td align="left">支付总额</td>
    </tr>
    <tr align="center">
        <td>refer_no</td>
        <td>string</td>
        <td>Y</td>
        <td>N</td>
        <td align="left">来源编号，接入商上送该参数，我方原封不动返回</td>
    </tr>
    <tr align="center">
        <td>claim_no</td>
        <td>string</td>
        <td>Y</td>
        <td>N</td>
        <td align="left">预理赔编号，需要通过该参数获取用户名下的有效保单，供其选择使用</td>
    </tr>
    <tr align="center">
        <td>callback</td>
        <td>string</td>
        <td>Y</td>
        <td>N</td>
        <td align="left">回调地址，接入方用于接收我方发送支付结果的地址</td>
    </tr>
</table>



示例

https://ok-api.okchexian.com/wallet/index.html#/pages/valid-policy/valid-policy?callback=http://callback.xxx.com/paymentresult&claim_no=CODE-xxxxxx&refer_no=xxxxxx





### 2.支付结果回调 (根据用户行为，可能会有多次回调)



当用户支付完成时，不管是成功与否，我们会发送回调通知接入方该用户的支付结果，接入方可通过该回调对订单状态进行更新。

> 注意：目前我方关闭订单的条件有两种，一种是 已经支付成功 ，一种是 超过支付截止时间
> 
> 因此，在未满足这两个条件时，该订单均可正常支付，即使支付失败，用户在我平台依然可继续进行支付，我们也会根据用户的支付结果再次发送支付结果回调。


请求方式：post

请求地址：接入方提供的回调地址



##### 请求参数列表

<table align="center">
    <tr align="center">
        <td>参数名称</td>
        <td>类型</td>
        <td>必选</td>
        <td>可为空</td>
        <td>参数描述</td>
    </tr>
    <tr align="center">
        <td>order_no</td>
        <td>string</td>
        <td>Y</td>
        <td>N</td>
        <td align="left">在OK直付生成的支付订单号</td>
    </tr>
    <tr align="center">
        <td>refer_no</td>
        <td>string</td>
        <td>Y</td>
        <td>N</td>
        <td align="left">接入方上送的来源编号，原封不动返回</td>
    </tr>
    <tr align="center">
        <td>res_code</td>
        <td>string/int</td>
        <td>Y</td>
        <td>N</td>
        <td align="left">状态码，当状态码为0时，代表支付成功</td>
    </tr>
    <tr align="center">
        <td>res_info</td>
        <td>string</td>
        <td>N</td>
        <td>Y</td>
        <td align="left">提示信息</td>
    </tr>
</table>



支付成功回调示例

![成功示例](./pay-res-callback-success.png)



支付失败回调示例

![失败示例](./pay-res-callback-error.png)




# 错误代码对照表

```
ZF0010:
ZF0020:
ZF0030:
ZF0040:
ZF0050:
ZF0060:
ZF0070:
ZF0080:
ZF0090:
ZF0100:
```


